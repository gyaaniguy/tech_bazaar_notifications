<?php require_once("includes/functions.php"); ?>
<?php require_once("includes/connection.php"); ?>
<?php require_once("includes/fetch_functions.php"); ?>
<?php require_once("includes/class.phpmailer-lite.php"); ?>
<?php
    include("includes/LIB_http.php")  ;

    if ( isset($_POST['submit']) )
    {
        $email = $_POST['email'] ;
        $query = "SELECT * FROM emails WHERE email = '{$email}' " ;
        $result = mysql_query($query, $connection);
        confirm_query($result) ;
        $row = mysql_fetch_array($result) ;
        $emailid = $row['id'] ;
        
        
        $keys = $_POST['key'] ;
        //foreach ($keys as $k )
        for ($k = 0 ; $k < count($keys) ; $k++ )
        {
            $keyword = $keys[$k]  ;
            echo $keyword ;
            
            $query = "DELETE FROM keywords WHERE email_id = '{$emailid}' AND keyword = '{$keyword}' " ;
            $result = mysql_query($query, $connection);
            confirm_query($result) ;
        }
        
        echo "submitted" ;
    }
    
	if ( isset($_GET['email']) )
	{
		$email = $_GET['email'] ;
		$query = "SELECT * FROM emails WHERE email = '{$email}' " ;
        $result = mysql_query($query, $connection);
        confirm_query($result) ;
        $row = mysql_fetch_array($result) ;
        echo $row['id'] ;
        
        $query = "SELECT * FROM keywords WHERE email_id = '{$row['id']}' " ;
        $result = mysql_query($query, $connection);
        confirm_query($result) ;
        
        echo "Your keywords, check to unsubscribe" ;
        echo " <form  name='unsub' method='post'>" ;
        while ( $keyword_row = mysql_fetch_array($result) )      
        {
            $row = $keyword_row['keyword'] ;
            echo "<input type='checkbox' name='key[]' value='{$row}' /> {$row}</br>" ;
        }
        echo "<input type='hidden' name='email' value='{$email}' />  " ;
        echo "<input type='submit' name='submit' value='Unsubscribe' />  " ;
        echo "</form>" ;
        
        
	}
    
    
?>